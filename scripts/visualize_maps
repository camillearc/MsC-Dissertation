#!/bin/bash

# Base directories
BASE_DIR="/Users/camillearcher/dissertation/ttest/combined_maps"
OUTPUT_BASE="/Users/camillearcher/dissertation/ttest/afni_visualizations_v2"
TEMPLATE="/Users/camillearcher/dissertation/ttest/past/MNI152_2009_template_SSW_copy.nii.gz"

# Create output base directory if it doesn't exist
mkdir -p "$OUTPUT_BASE"

# Find all files containing 'combined_map' in their names
find "$BASE_DIR" -type f -name "*combined_map*.nii*" | while read -r input_file; do
    # Get relative path from BASE_DIR
    rel_path="${input_file#$BASE_DIR/}"
    
    # Get directory path relative to BASE_DIR
    rel_dir=$(dirname "$rel_path")
    
    # Get base filename without extension
    base_name=$(basename "$input_file" .nii.gz)
    base_name=$(basename "$base_name" .nii)
    
    # Create output directory
    output_dir="$OUTPUT_BASE/$rel_dir"
    mkdir -p "$output_dir"
    
    echo "Processing: $rel_path"
    
    # Run AFNI's chauffeur to create the visualization
    # Using [0] to explicitly specify the first sub-brick of the template
    @chauffeur_afni \
        -ulay "$TEMPLATE[0]" \
        -olay "$input_file" \
        -box_focus_slices AMASK_FOCUS_ULAY \
        -ulay_range 0% 130% \
        -cbar "5=yellow 4=cyan 3=blue 2=green 1=red 0=none" \
        -func_range 5 \
        -pbar_posonly \
        -opacity 6 \
        -prefix "$output_dir/$base_name" \
        -pbar_saveim "$output_dir/${base_name}_glass.png" \
        -set_xhairs OFF \
        -montx 3 -monty 3 \
        -label_mode 1 -label_size 4
    
    echo "Saved visualization to: $output_dir/${base_name}_glass.png"
done

echo "All visualizations completed!"
